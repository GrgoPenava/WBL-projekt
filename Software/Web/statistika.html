<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="author" content="PiWBL" />
  <meta name="description" content="FOI" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/glavni.css" />
  <link rel="stylesheet" href="css/pocetnaStranica.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.js"></script>
  <input type="hidden" name="smname" id="id" />
<script type="module" src="Javascript/statistika.js"></script>
<script>
  
  const dohvatiParkingSpotsZaParkingSpace = async () => {
      var idSpacea = document.getElementById("parkirniSpaceovi").value;
      const response = await fetch(
        "https://localhost:7236/api/Parking/TypeOfParkingSpotsPerParkingSpace?Id=" + idSpacea,
        {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        }
      );
      const myJson = await response.json();

      return myJson;
    };

    const dohvatiSenzore = async () => {
      var idSpacea = document.getElementById("parkirniSpaceovi").value;
      const response = await fetch('https://localhost:7236/api/Parking/SensorsForParkingSpace?Id=' + idSpacea, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      const myJson = await response.json();

      return myJson;

    }

    const dohvatiPostotke = async () => {
      var datum = document.getElementById("datumStatitika").value;
      const response = await fetch('https://localhost:7236/api/MachineLearning/PercentageOfFreeParking?datum=' + datum, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      const myJson = await response.json();

      return myJson;

    }


    var myDoughnutChart_2;
    var prviChart;
    var drugiChart;
    Chart.defaults.global.defaultFontSize = 16;
    Chart.defaults.global.defaultFontColor = '#b3b3b3';
    Chart.defaults.global.defaultFontFamily = 'Helvetica';
    function prikazi() {

      if(myDoughnutChart_2 != undefined)
        myDoughnutChart_2.destroy();

      if(drugiChart != undefined)
        drugiChart.destroy();

      if(prviChart != undefined)
        prviChart.destroy();

      Promise.any([dohvatiSenzore()])
        .then(podaci2 => {
          $(function () {
            var x = 0;
            prviChart = new Chart(document.getElementById("prvi"), {
              type: 'bar',
              data: {
                labels: ["Senzor ID:" + podaci2[x].snrSensorId, "Senzor ID:" + podaci2[x + 1].snrSensorId, "Senzor ID:" + podaci2[x + 2].snrSensorId, "Senzor ID:" + podaci2[x + 3].snrSensorId, "Senzor ID:" + podaci2[x + 4].snrSensorId, "Senzor ID:" + podaci2[x + 5].snrSensorId, "Senzor ID:" + podaci2[x + 6].snrSensorId, "Senzor ID:" + podaci2[x + 7].snrSensorId, "Senzor ID:" + podaci2[x + 8].snrSensorId, "Senzor ID:" + podaci2[x + 9].snrSensorId,],
                datasets: [
                  {
                    label: "Battery",
                    backgroundColor: "#3e95cd",

                    data: [podaci2[x].snrNbpsBatteryLevel, podaci2[x + 1].snrNbpsBatteryLevel, podaci2[x + 2].snrNbpsBatteryLevel, podaci2[x + 3].snrNbpsBatteryLevel, podaci2[x + 4].snrNbpsBatteryLevel, podaci2[x + 5].snrNbpsBatteryLevel, podaci2[x + 6].snrNbpsBatteryLevel, podaci2[x + 7].snrNbpsBatteryLevel, podaci2[x + 8].snrNbpsBatteryLevel, podaci2[x + 9].snrNbpsBatteryLevel,]
                  }
                ]
              },
              options: {
                legend: { display: false },
                title: {
                  display: true,
                  text: 'Prikaz 10 senzora parkirnog spacea s najslabijim baterijama'
                },
              }
            });
          })
          })

      Promise.any([dohvatiPostotke()]).then((podaci3) => {
        $(function () {
          // console.log(podaci3);
          // console.log(podaci3[0]);
          // console.log(podaci3.length);
          for (var z = 0; z < podaci3.length;  z++) {
            var splitano = podaci3[z].split(';');
            var splitanoDva = splitano[1].split(',');
            // console.log(splitanoDva[0]);
            drugiChart = new Chart(document.getElementById("treci"), {
              type: 'bar',
              data: {
                labels: [],
                datasets: [
                  {
                    label: "Postotak zauzetosti parkirnih mjesta",
                    backgroundColor: "#3e95cd",
                    data: []
                  }
                ]
              },
              options: {
                legend: { display: false },
                title: {
                  display: true,
                  text: 'Postotak zauzetosti:'
                },

              }
            });
          }
        })
      });

      Promise.any([dohvatiParkingSpotsZaParkingSpace()])
      .then(datas => {
        // console.log(datas);
        var splitano = datas[0].split(";");
        //console.log(splitano);
        var regularSplitano;
        var handicappedSplitano;
        var reservedSplitano;
        var taxiSplitano;
        var chargingSplitano;
        for(var i = 0; i < 5; i++){
          if(splitano[i] == "" || splitano[i] == undefined){
            break;
          } else {
            var splitanI = splitano[i].split(':');
            if(splitanI[0].localeCompare("Regular") === 0)
              regularSplitano = splitanI[1];
            else if(splitanI[0].localeCompare("Handicapped") == 0)
              handicappedSplitano = splitanI[1];
            else if(splitanI[0].localeCompare("TAXI") == 0)
              taxiSplitano = splitanI[1];
            else if(splitanI[0].localeCompare("Reserved") == 0)
              reservedSplitano = splitanI[1];
            else if(splitanI[0].localeCompare("Charging") == 0)
              chargingSplitano = splitanI[1];
          }
        }
          $(function () {
            var ctx_2 = document.getElementById("drugi").getContext('2d');
            var data_2 = {
              datasets: [{
                data: [regularSplitano, handicappedSplitano, reservedSplitano, taxiSplitano, chargingSplitano],
                backgroundColor: [
                  '#3c8dbc',
                  '#f56954',
                  '#f39c12',
                  '#f4dddd',
                  '#80D943',
                ],
              }],
              labels: [
                'Obično parking mjesto',
                'Invalidsko parking mjesto',
                'Rezervirano parking mjesto', 
                'Mjesto za TAXI',
                'Parking mjesto za punjenje',
              ]
            };

            myDoughnutChart_2 = new Chart(ctx_2, {
              type: 'doughnut',
              data: data_2,
              options: {
                responsive: false,
                maintainAspectRatio: false,
                legend: {
                  position: 'bottom',
                  labels: {
                    boxWidth: 12
                  }
                }
              }
            });


          });
      })
      .catch(error => {
        console.error("Failed to fetch")
      });
    }

</script>

  <title>Statistika</title>
</head>

<body id="tijeloPrijave">
  <div id="ovdjeNavigacija"></div>
    <script>
      if(sessionStorage.getItem("card_id") == undefined){
      var html = [
            '<div>',
            '<nav id="navigacija">',
            '<a href="index.html">POČETNA</a>',
            '<a id="trenutni" href="#">STATISTIKA</a>',
            '<a href="obrasci/prijava.html">PRIJAVA</a>',
            '<a id="trenutniRegistracija" href="obrasci/registracija.html">REGISTRACIJA</a>',
            '</nav>',
            '</div>'
          ].join('\n');
        document.getElementById("ovdjeNavigacija").innerHTML += html;
      } else {
        var html = [
            '<div>',
            '<nav id="navigacija">',
            '<a href="index.html">POČETNA</a>',
            '<a id="trenutni" href="statistika.html">STATISTIKA</a>',
            '<a href="algoritam.html">ALGORITAM</a>',
            '<a id="trenutniRegistracija" href="odjava.html">ODJAVA</a>',
            '</nav>',
            '</div>'
          ].join('\n');
        document.getElementById("ovdjeNavigacija").innerHTML += html;
      }
    </script>

<div class="spaceodabir" style="display: flex; gap: 20px;padding-left: 36%; padding-bottom: 15px;">
  <div>
  <label style="
      padding-right: 10px;
      color: #b3b3b3;
      font-size: 19px;
    ">
    Odaberite parking space:
  </label>      
  <label style="
  padding-left: 30px;
  padding-right: 10px;
  padding-bottom: 10px;
  color: #b3b3b3;
  font-size: 19px;
    ">
    Odaberite datum:
  </label>
  <form onsubmit="prikazi()" id="mojaForma" name="mojaForma" >
    <select name="parkingSpace" id="parkirniSpaceovi">
    </select>
  <input type="datetime-local" id="datumStatitika" name="datumStatitika"
    value="2021-01-01T00:00" style="margin-left: 15px; padding-right: 25px" />
    <input type="submit" value="Prikaži" style="width:100px;"></input>
  </form>

  </div>
  <br>
</div>

  <div class="container">
    <div class="klasa1">
      <canvas id="prvi" width="1425px" height="300px"></canvas>
    </div>

    <div class="klasa3">
      <canvas id="treci" width="1400px" height="300px"></canvas>
    </div>
    <div class="klasa2">
      <canvas id="drugi" width="300px" height="300px"></canvas>
    </div>

    </div>
  </div>

</body>

</html>